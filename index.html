<!DOCTYPE html>

<!-- define angular app -->
<!-- <html xmlns:ng="http://angularjs.org" id="ng-app" ng-app="ndexApp">  -->
<html xmlns:ng="http://angularjs.org" id="ng-app">

<head>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link type="text/css" rel="stylesheet" href="node_modules/qtip2/dist/jquery.qtip.css" />
    <!-- This CODE is to help with IE Explorer problems... -->
    <!--[if lte IE 7]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
    <![endif]-->

    <!--[if lte IE 8]>
    <script>
        document.createElement('ng-include');
        document.createElement('ng-pluralize');
        document.createElement('ng-view');

        // Optionally these for CSS
        document.createElement('ng:include');
        document.createElement('ng:pluralize');
        document.createElement('ng:view');
    </script>
    <![endif]-->
    <!-- End IE Explorer problem code. -->


    <!-- Load script that may redirect to maint.html -->
    <script src="checkMaintenance.js"></script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="css/ndex-angular-site.css"/>
    <link rel="stylesheet" href="css/visualize_network.css"/>
    <link rel="styleSheet" href="lib/ui-grid/3.0.1/ui-grid.min.css"/>

    <!-- Scripts -->

    <!-- it is important to load angular *after* jQuery if you want angular to have access
         to full jQuery functionality instead of angular's internal 'lite' version -->
    <script src="node_modules/jquery/dist/jquery.js"></script>

    <!-- Latest version of cytoscape.js for visualization -->
    <script src="node_modules/cytoscape/dist/cytoscape.js"></script>
    <script src="node_modules/lodash/lodash.js"></script>
    <script src="node_modules/ev-emitter/ev-emitter.js"></script>
    <script src="node_modules/imagesloaded/imagesloaded.js"></script>
    <script src="node_modules/qtip2/dist/jquery.qtip.js"></script>
    <script src="node_modules/qtip2/dist/basic/jquery.qtip.js"></script>
    <script src="node_modules/cytoscape/dist/cytoscape.js"></script>
    <script src="node_modules/cytoscape-qtip/cytoscape-qtip.js"></script>




    <!-- Standard Angular API scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-touch.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-resource.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-sanitize.min.js"></script>
    <script  src="https://apis.google.com/js/api.js"></script>
 <!--   <script async defer src="https://apis.google.com/js/api.js"
            onload="this.onload=function(){};handleClientLoad()"
            onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>

    <!-- angular file upload module -->
    <script src="lib/angular-file-upload/1.1.5/angular-file-upload.min.js"></script>

    <!-- Angular bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.12.0/ui-bootstrap-tpls.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>


    <!-- ndex scripts -->
    <script src="ndex-webapp-settings.js"></script>
    <script src="js/init.js"></script>
    <script src="js/ndex-service-app.js"></script>
    <script src="ndex-webapp-config.js"></script>
    <script src="js/ndex-service-factory.js"></script>
    <script src="js/services/networkService.js"></script>
    <script src="js/ui-service.js"></script>
    <script src="js/app.js"></script>
    <script src="js/services/sharedProperties.js"></script>
    <script src="js/services/cx-network-utils.js"></script>
    <script src="js/services/cy-service.js"></script>
    <script src="js/services/provenance-service.js"></script>
    <script src="js/services/ui-misc.js"></script>
    <script src="js/services/log-in-service.js"></script>

    <!-- page controllers -->
    <script src="js/controllers/main.js"></script>
    <script src="js/controllers/sign-in-controller.js"></script>
    <script src="js/controllers/search-controller.js"></script>
    <script src="js/controllers/network-controller.js"></script>
    <script src="js/controllers/user-controller.js"></script>
    <script src="js/controllers/upload-controller.js"></script>
    <script src="js/controllers/group-controller.js"></script>
    <script src="js/controllers/network-set-controller.js"></script>
    <script src="js/controllers/edit-network-properties-controller.js"></script>
    <script src="js/controllers/edit-network-properties-controller-fixed-form.js"></script>
    <script src="js/controllers/manage-network-access.js"></script>
    <script src="js/controllers/manage-bulk-network-access.js"></script>
    <script src="js/controllers/manage-group-access.js"></script>
    <script src="js/controllers/api-controller.js"></script>
    <script src="js/controllers/home-controller.js"></script>
    <script src="js/controllers/my-account-controller.js"></script>

    <!-- newer third party libraries -->
    <script src="lib/vis/3.10/vis.js"></script>
    <script src="lib/ui-grid/3.0.1/ui-grid.min.js"></script>
    <script src="lib/ng-idle/angular-idle.min.js"></script>



    <!-- ngclipboard directives for copying NDEx Citation to clipborad;
         source: https://sachinchoolur.github.io/ngclipboard/ -->
    <script src="lib/ngclipboard-master/dist/clipboard.js"></script>
    <script src="lib/ngclipboard-master/dist/ngclipboard.min.js"></script>

    <!-- to-markdown is taken from https://cdnjs.cloudflare.com/ajax/libs/to-markdown/1.3.0/to-markdown.min.js
         Documented here: https://github.com/domchristie/to-markdown
         Used to convert HTML to markdown with toMarkdown() function
    -->
    <script src='lib/to-markdown/1.3.0/to-markdown.min.js'></script>


    <link rel='stylesheet' href='lib/textAngular-1.5.0/dist/textAngular.css'>
    <script src='lib/textAngular-1.5.0/dist/textAngular-rangy.min.js'></script>
    <script src='lib/textAngular-1.5.0/dist/textAngular-sanitize.min.js'></script>
    <script src='lib/textAngular-1.5.0/dist/textAngular.min.js'></script>

    <script src='lib/file-saver/FileSaver.js'></script>

    <script src='lib/spin/spin.js'></script>


</head>


<!-- define angular controller -->
<body ng-controller="mainController" style="padding-bottom: 20em;height: 100%;">

<!-- template for search bar -->
<script type="text/ng-template" id="search_bar.html">
    <div class="" style="background-color:white; color:black;">
        <form ng-show="!main.serverIsDown && (!config.requireAuthentication||main.loggedIn)"
              ng-submit="main.search()">

            <table class="table">

                    <div class="input-group">
                        <tr style="border:hidden">
                            <td style="width: 70px;"  bgcolor="#FFFFFF">

                                <div class="input-group-btn dropdown">
                                    <button type="button" class="btn btn-default dropdown-toggle"
                                            data-toggle="dropdown" style="border-radius: 24px;">
                                        Search Examples <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" role="menu">

                                        <li class="AlignLeft" style="padding-left: 5px;"
                                            ng-repeat="item in main.searchNetworksExamples">
                                            <a ng-click="main.runSearchExample(item); closeModal()">
                                                {{item.description}}
                                            </a>
                                        </li>

                                        <li class="AlignLeft" ng-show="config.searchDocLink">
                                            <a style="color:#428bca; background-color:white;"
                                               ng-click="redirectToExternalLink(config.searchDocLink); closeModal()">
                                                <u>{{config.searchDocLink.label}}</u>
                                            </a>
                                        </li>

                                    </ul>
                                </div>
                            </td>

                            <td style="width: 35px;"  bgcolor="#FFFFFF">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-default"
                                            ng-click="main.browse(); closeModal()" style="border-radius: 24px;">Browse
                                    </button>
                                </div>
                            </td>

                            <td bgcolor="#FFFFFF">
                                <div class="row" style="margin-left:5px; margin-right:5px">

                                    <div class="input-group">

                                        <span class="input-group-btn dropdown"
                                            style="border-bottom-right-radius:0px; border-top-right-radius:0px">
                                            <button type="button" class="btn btn-default dropdown-toggle"
                                                    data-toggle="dropdown" style="margin-right:-2px;">
                                                {{main.searchType}} <span class="caret"></span>
                                            </button>

                                            <ul class="dropdown-menu" role="menu">
                                                <li><a class="dropdown-toggle"
                                                       ng-click="main.searchType = 'All'; main.searchString = ''">All NDEx</a></li>
                                                <li><a class="dropdown-toggle"
                                                       ng-click="main.searchType = 'Networks'; main.searchString = ''">Networks</a></li>
                                                <li><a class="dropdown-toggle"
                                                       ng-click="main.searchType = 'Users'; main.searchString = ''">Users</a></li>
                                                <li><a class="dropdown-toggle"
                                                       ng-click="main.searchType = 'Groups'; main.searchString = ''">Groups</a></li>
                                            </ul>
                                        </span>

                                        <input type="text"
                                               class="form-control"
                                               placeholder="{{main.getSearchPlaceholder()}}"
                                               ng-model="main.searchString"
                                               maxlength="{{maxSearchInputLength}}"
                                               ng-change="checkLengthOfSearchString()">

                                        <!--!$scope.main.searchString-->

                                        <span class="input-group-btn">
                                            <button ng-disabled="!main.searchString" type="submit" ng-click="closeModal();" class="btn btn-default">
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr ng-show="stringTooLongWarning">
                            <td bgcolor="#FFFFFF"></td>
                            <td bgcolor="#FFFFFF"></td>

                            <td bgcolor="#FFFFFF">
                                <div ng-show="stringTooLongWarning"
                                     style="color:red; font-size:1.15em; font-weight:bold; margin-left:60px;"
                                     ng-bind-html="stringTooLongWarning">
                                </div>
                            </td>
                        </tr>

                        <tr style="border:hidden">
                            <td bgcolor="#FFFFFF"></td>
                            <td bgcolor="#FFFFFF"></td>

                            <td bgcolor="#FFFFFF">
                                <div class="row" style="margin-left:60px;">

                                    <input type="checkbox"
                                           ng-hide="checkSearchTypeAndTermExpansion()"
                                           title="{{main.searchTitle}}"
                                           ng-model="main.searchTermExpansionSelected">
                                            &nbsp;
                                            <span ng-style="searchTermExpansionEnabled ?
                                            {'color':'black', 'font-size':'1.15em'} : {'color':'red', 'font-size':'1.15em'}">
                                                <strong>{{main.searchTitle}}</strong>
                                            </span>

<!--
<span ng-style="networkSetController.networkSetShareableURL ? {color:'green'} : {color:'black'}">

                                    <i disabled ng-show="searchTermExpansion.selected" style="color: green;"
                                       class="fa fa-check-square fa-lg" aria-hidden="true"></i>
                                    <i disabled ng-show="!searchTermExpansion.selected"
                                       class="fa fa-square-o fa-lg" aria-hidden="true"></i>

                                    <span ng-style="searchTermExpansion.selected ? {'font-size':'1.1em', 'color':'black'} : {'font-size':'1.1em', 'color':'#878787'}">
                                        &nbsp;Perform Search Term Expansion (genes and proteins only)
                                    </span>
 -->
                                </div>

                            </td>
                        </tr>

                    </div>

            </table>
        </form>
    </div>
</script>

<!-- Nav Bar -->
<nav class="navbar navbar-fixed-top">
    <div class="navbar-ndex navbar-ndex-top" style="padding-right: 20px;">
        <div class="navbar-header">
            <button type="button"
                    class="navbar-toggle"
                    data-toggle="collapse"
                    data-target="#myNavbar">

                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="navbar-brand"
               ng-href="{{$location.path()}}"
               ng-click="collapseHamburgerMenu(); redirectToCurrentServer()"
               style="max-height: 50px; padding-top: 0; padding-bottom: 0;">

                <div style="
                    background-image: url('img/NDEx-horizontal-transparent.png');
                    background-repeat: no-repeat;
                    background-position: 0px 10px;
                    width: 120px;
                    height: 50px;
                    margin-left: 5px;
                    margin-right: 0px;
                    background-size: 120px 30px;">
                </div>
            </a>
        </div>

        <div class="navbar-collapse collapse" id="myNavbar">

            <ul class="nav navbar-nav navbar-left" ng-show="!main.serverIsDown">
                <li>
                    <a ng-href="{{$location.path()}}"
                       ng-click="collapseHamburgerMenu(); redirectToExternalLink(config.newsLink)">{{config.newsLink.label}}
                    </a>
                </li>

                <li>
                    <a ng-href="{{$location.path()}}"
                       ng-click="collapseHamburgerMenu(); redirectToExternalLink(config.aboutLink)">{{config.aboutLink.label}}
                    </a>

                </li>
                <li>
                    <a ng-href="{{$location.path()}}"
                       ng-click="collapseHamburgerMenu(); redirectToExternalLink(config.documentationLink)">
                        {{config.documentationLink.label}}
                    </a>
                </li>
                <!--
                <li>
                    <a ng-href="{{$location.path()}}"
                       ng-click="collapseHamburgerMenu(); redirectToExternalLink(config.apiLink)">
                        {{config.apiLink.label}}
                    </a>
                </li>
                -->
                <li>
                    <a ng-href="{{$location.path()}}"
                       ng-click="collapseHamburgerMenu(); redirectToExternalLink(config.reportBugLink)">
                        {{config.reportBugLink.label}}
                    </a>
                </li>
                <li>
                    <a ng-href="{{$location.path()}}"
                       ng-click="collapseHamburgerMenu(); redirectToExternalLink(config.contactUsLink)">
                        {{config.contactUsLink.label}}
                    </a>
                </li>
                <li>
                    <a ng-click="collapseHamburgerMenu(); showNDExCitationInClipboardMessage()"
                       ngclipboard data-clipboard-text="{{NDEx.citation}}">
                        {{config.citeNDEx.label}}
                    </a>
                </li>

            </ul>

            <ul class="nav navbar-nav navbar-right">

                <li ng-show="showSearchMenu">
                    <a ng-click="collapseHamburgerMenu(); showSearchBar()">
                        <div style="
                            background-image: url('img/search-icon.png');
                            margin-top: -5px;
                            margin-bottom: -5px;
                            width: 30px;
                            height: 30px;
                            background-size: 30px 30px;
                            ">
                        </div>
                    </a>
                </li>


                <li ng-show="main.loggedIn">
                    <a ng-click="collapseHamburgerMenu(); main.goToCurrentUser()"
                       ng-class="{'selected-navbar-item' : isActiveUserView('/myAccount/')}">

                        <img src="img/home.png" style="float:left; width:30px; height:30px; margin-bottom:-5px; margin-top:-5px;">
                        &nbsp;&nbsp;{{main.userFirstAndLastNames}}!
                    </a>
                </li>

                <li ng-show="main.loggedIn">
                    <a ng-click="collapseHamburgerMenu(); main.signout()">Sign Out</a>
                </li>

                <li ng-show="!main.loggedIn && !config.requireAuthentication && !main.serverIsDown && main.showSignIn">
                    <a ng-click="collapseHamburgerMenu(); main.startSignIn()">Sign In</a>
                </li>

            </ul>

        </div>

    </div>

</nav>

<div id="main" class="container-fluid">
    <!-- angular templating -->
    <!-- this is where content will be injected -->

    <div id="searchBarId" ng-hide="main.hideSearchBar"
         class="marginsForNGView" style="background-color: white;  ">
        <div style="max-width: 1000px; margin-left: auto; margin-right: auto;">
            <ng-include src="'search_bar.html'"></ng-include>
        </div>

    </div>

    <div ng-view class="marginsForNGView"></div>

</div>


<!--
<div ng-show='showFooter'>
    <nav class="navbar navbar-ndex navbar-fixed-bottom footer-bar AlignCenter"  >
        <div class='footer-content' >
            Copyright &copy; 2016 Regents of the University of California and The Cytoscape Consortium. All rights
            reserved.
            &nbsp;<a href="http://home.ndexbio.org/disclaimer-license/">Terms & Conditions</a>
        </div>
    </nav>
</div>
-->


<div ng-show='showFooter'>
    <nav class="navbar navbar-ndex navbar-fixed-bottom footer-bar AlignCenter"  >
        <div class='footer-content' >
            Copyright &copy; 2013-<script type="text/javascript">var d = new Date(); document.write(d.getFullYear());</script>,
            The Regents of the University of California, The Cytoscape Consortium.
            All rights reserved.
            &nbsp;<a href="http://home.ndexbio.org/disclaimer-license/">Terms & Conditions</a>
        </div>
    </nav>
</div>


<script>

  /*  function onSignIn(googleUser) {
            // Useful data for your client-side scripts:
        var foo = angular.element('#ng-app').injector().get("sharedProperties").testMe();
        console.log (foo);       var profile = googleUser.getBasicProfile();
        console.log("ID: " + profile.getId()); // Don't send this directly to your server!
        console.log('Full Name: ' + profile.getName());
        console.log('Given Name: ' + profile.getGivenName());
        console.log('Family Name: ' + profile.getFamilyName());
        console.log("Image URL: " + profile.getImageUrl());
        console.log("Email: " + profile.getEmail());

        // The ID token you need to pass to your backend:
        var id_token = googleUser.getAuthResponse().id_token;
        console.log("ID Token: " + id_token);

        var sharedProperties = angular.element('#ng-app').injector().get("sharedProperties");
        sharedProperties.setIdToken();

        var bar = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse();
        var tt = bar.id_token;
        console.log("Id token 2: " + tt);

        angular.injector(['ng', 'ndexServiceApp']).get("ndexService").authenticateUserWithIdToken(
            function(data) {
                angular.element('#ng-app').injector().get("sharedProperties").setCurrentUser(data.externalId, data.userName); //this info will have to be sent via emit if we want dynamic info on the nav bar
                angular.injector(['ng', 'ndexServiceApp']).get("ndexUtility").setUserInfo(data.userName, data.firstName, data.lastName, data.externalId);
//                $rootScope.$emit('LOGGED_IN');
                //$location.path("/user/" + data.externalId);//
        //        $location.path("/myAccount");
        //        $scope.signIn.userName = null;
        //        $scope.signIn.password = null;
                console.log("user authenticated: " + data);
            },
            function(error, status) { //.error(function (data, status, headers, config, statusText) {

                if (error && error.message) {
                    $scope.signIn.message = error.message;
                } else {
                    $scope.signIn.message = "Unexpected error during sign-in with status " + error.status;
                }
            }
        )
    }

    function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
            console.log('User signed out.');
        });
    }
*/

    $(window).resize(function() {
        $('#cytoscape-canvas').height($(window).height() - 200);
        $("#divNetworkTabs").height($(window).height() - 200);
    });

    $(window).trigger('resize');


  function initClient() {
      gapi.client.init({
          clientId: ndexSettings.googleClientId,
          scope: 'profile email',
      }).then(function () {
          var initInjector = angular.injector(["ng"]);
          var $http = initInjector.get("$http");

          isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();

          if (isSignedIn) {
              var curUser = gapi.auth2.getAuthInstance().currentUser.get();
              var id_token = curUser.getAuthResponse().id_token;

              $http({
                  method: 'GET',
                  url: ndexSettings.ndexServerUri + "/user?valid=true&setAuthHeader=false",
                  headers: {
                      Authorization: "Bearer " + id_token
                    }
                  }
              )
                  .success(function(data, status, headers, config, statusText) {
                      startWebApp(data, 'google');
                  })
                  .error(function(error, status, headers, config, statusText) {
                      startWebApp(null,null);
                  })

          } else {
              var loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

              if (loggedInUser) {
                  $http({
                          method: 'GET',
                          url: ndexSettings.ndexServerUri + "/user?valid=true&setAuthHeader=false",
                          headers: {
                              Authorization: "Basic " + btoa(loggedInUser.userName + ":" + loggedInUser.token)
                          }
                      }
                  )
                      .success(function(data, status, headers, config, statusText) {
                          startWebApp(data, 'basic');
                      })
                      .error(function(error, status, headers, config, statusText) {
                          startWebApp(null,null);
                      })
              } else {
                  angular.bootstrap(document, ['ndexApp']);
              }
          }
      });

  }

  function startWebApp (signedInUser, type) {

      if ( signedInUser !=null ) {
          window.currentNdexUser = signedInUser;
          window.currentSignInType = type;
      }
      angular.bootstrap(document, ['ndexApp']);

  }


  gapi.load('client:auth2', initClient);


</script>


</body>

</html>
